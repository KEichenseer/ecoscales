---
title: "Main Analyses - Figure 3"
output: 
  rmarkdown::html_vignette:
    toc: yes
    number_sections: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{6. Main Analyses - Figure 3}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', fig.height = 4, 
                      fig.width = 6, cache = TRUE)
```
```{r, echo=FALSE}
e <- TRUE
e2 <- TRUE
```

# Overview

The resampled full dataset created in the [Data Pre-processing vignette](data-pre-process.html) is used to calculate and plot the magnitude of difference extent and actual extent and duration and actual duration.

# Analyses
## Data and libraries

```{r, message = FALSE, warning=FALSE}
library(ecoscales)
library(viridis)
library(ggplot2)
data("dimbreaks")
data("bootperturb")
```

## Actual versus effective duration/extent

Prepare the data for creating boxplots: calculate differences between log-transformed actual and effective extents/durations, assign the values to different bins (intervals) of extent/duration, calculate the percentage of observations in each bin. 
```{r, eval = e}
kdat <- rbindlist(bootperturb)

# limits
xyvars <- list(c(x = "eff_ext", y = "act_ext"),  # variable pairs 
               c(x = "eff_dur", y = "act_dur"))
lims <- list("eff_ext" = range(aaxis2$logarea), # limits
             "act_ext" = range(aaxis2$logarea), 
             "eff_dur" = range(taxis2$logdays[-5]), 
             "act_dur" = range(taxis2$logdays[-5]))
ivals <- list("ext" = aaxis2$logarea, "dur" = taxis2$logdays[-5])
dropones <- c(FALSE, TRUE)
onms <- list(c("eext", "aext"), c("edur", "adur"))
wgtint <- c(0, 1, seq(5, 40, 5)) / 100
wgttxt <- (c("  0", "  1", "  5", seq(10, 40, 5)))

dif_ints <- lapply(1:length(xyvars), function(x) {  # x <- 2
  xyv <- xyvars[[x]]
  onm <- onms[[x]]
  ival <- ivals[[x]]
  xl <- lims[[xyv["x"]]]
  yl <- lims[[xyv["y"]]]
  
  o <- copy(kdat)
  if(x == 2) o <- o[t_btwn_samp != 365 * 10000, ]
  type <- o$type
  type[type == "other"] <- "remote"
  o <- o[, list("x" = get(xyv["x"]), "y" = get(xyv["y"]))]
  o <- o[, lapply(.SD, log10)]
  o <- cbind(type, o)
  o[x < xl[1], x := xl[1]]  # confine x to min
  o[x > xl[2], x := xl[2]]  # confine x to max
  o[y < yl[1], y := yl[1]]  # confine y to min
  o[y > yl[2], y := yl[2]]  # confine y to max
  o <- na.omit(o)

  # difference and intervals - if want to plot versus actual dur/ext, switch
  # x for y in findInterval
  o[, dif := x - y]
  o[, int := findInterval(x, ival, rightmost.closed = TRUE)]
  setnames(o, c("x", "y"), onm)
  
  # plot related variables, finding percentages in each bin, occupied intervals 
  ints <- sort(o[, unique(int)])
  pctobs <- sapply(ints, function(i) o[int == i, .N])
  wgt <- pctobs / sum(pctobs)
  wgti <- c(0, 1, seq(5, max(round(wgt, 1)) * 100, 5))
  cols <- findInterval(wgt, wgti / 100)  # corresponding color index
  return(list("db" = o, "wgt" = wgt, "wgti" = wgti,
              "col" = cols, "xl" = xl, "yl" = yl, "ival" = ival, "ints" = ints))
})
names(dif_ints) <- c("e", "d")

```

## Figure 3

Box plots by bins of extent/duration, colored and labelled by the percent of observations per bin.

```{r, eval = e2}
# y grid line function
ylines <- function(yr, by, lty = 1, col = "grey") {
  abline(h = seq.int(from = yr[1], to = yr[2], by = 2), lty = lty, col = col)
}

cxa <- 0.7
ayl <- c(0, 20)
byl <- c(0, 40)

colpals <- c("Blues", "Reds")
ylabs <- c("Extent", "Duration")
a2mgp <- c(3, 0.5, 0)
bwex <- c(0.9, 1.4)

png("figures/fig3.png", width = 7, height = 4, res = 600, 
    units = "in")
par(mfrow = c(1, 2), mar = c(4, 0, 1, 0.75), oma = c(0, 3, 0, 0))
for(i in 1:2) {  # i <- 1
  di <- dif_ints[[i]]  # subset list element
  bxa <- rowMeans(cbind(di$ival[-length(di$ival)], di$ival[-1]))[di$ints]
  bxw <- (di$ival[-1] - di$ival[-length(di$ival)])[di$ints]
  cols <- brewer.pal(length(di$wgti) - 1, colpals[[i]])
  mus <- di$db[order(int), list("mu" = mean(dif)), by = int]

  yls <- c(0, 14)
  plot(di$xl, yls, pch = "", xlab = "", ylab = "", xaxt = "n", yaxt = "n",
       mgp = c(3, 0.5, 0), tcl = -0.2, xaxs = "i")
  polygon(c(di$xl, rev(di$xl), di$xl[1]), c(-1, -1, rep(yls[2] * 1.2, 2), -1), 
          col = "grey90")
  ylines(yr = yls, by = 2, col = "grey95")
  b <- boxplot(formula = dif ~ int, data = di$db, col = cols[di$col], 
               range = 0, width = bxw, at = bxa, xlim = di$xl, boxwex = bwex[i], 
               axes = FALSE, outline = FALSE, lty = 1, add = TRUE, 
               staplewex = 0.2)
  points(bxa, mus$mu, pch = 20, col = "black")
  text(bxa, b$stats[5, ] + 0.15, round(di$wgt * 100, 1), cex = 0.3)
  
  axis(1, at = ivals[[i]], labels = list(alab2, tlab2[-c(5)])[[i]], las = 2, 
       tcl = -0.2, cex.axis = cxa, mgp = c(3, 0.5, 0))
  at <- seq(0, yls[2], 2)
  if(i == 1) axis(2, at, las = 2, tcl = -0.2, cex.axis = cxa, mgp = a2mgp)
  if(i == 2) {
    axis(2, at, labels = rep("", length(at)), las = 2, tcl = -0.2,
         cex.axis = cxa, mgp = a2mgp)
  }
  mtext(ylabs[i], side = 1, line = 3, cex = 0.9)
  if(i == 1) {
    mtext("Magnitude of difference between Extent/Duration", side = 2, 
          line = 2.2, cex = 0.9)
    mtext("and Actual Extent/Duration", side = 2, line = 1.4, cex = 0.9)
  }
  lrng <- c(min(di$xl) - 0.05 * min(di$xl), mean(di$xl))
  xs <- seq(lrng[1], lrng[2], by = (diff(lrng)) / (length(cols)))
  rect_shade(xs, y = c(13, 14), fillcol = cols, linecol = "grey30")
  text(xs, rep(12.5, length(xs)), di$wgti, srt = 90, col = "grey30", cex = cxa)
  text(mean(xs), 14.25, "% of observations", col = "grey30", cex = cxa)
  mtext(c("A", "B")[i], side = 3, line = 0, cex = 1, adj = 0.02)
}
dev.off()

```

## Observational type by bin

To see how much different observational types contribute to each bin.

```{r, eval = e}
dif_ints$e$db[order(int), .N, by = list(int, type)][, {
  ggplot() + aes(x = int, y = N, color = type) + geom_line() +
    scale_color_brewer(type = "div") +
    xlab("Extent interval")
}]

dif_ints$d$db[order(int), .N, by = list(int, type)][, {
  ggplot() + aes(x = int, y = N, color = type) + geom_line() + 
    scale_color_brewer(type = "div") +
    xlab("Duration interval")
}]


```

